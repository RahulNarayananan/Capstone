<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PharmaTrace - Drug Authenticity dApp</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .tab-button.active {
            border-color: #3b82f6;
            color: #3b82f6;
            font-weight: 600;
        }
        #qr-reader-container {
            position: relative;
            width: 100%;
            padding-top: 75%; /* 4:3 Aspect Ratio */
            overflow: hidden;
            border-radius: 0.5rem;
        }
        #qr-reader {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }
        .scanner-line {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: rgba(239, 68, 68, 0.8);
            box-shadow: 0 0 10px rgba(239, 68, 68, 1);
            border-radius: 3px;
            animation: scan 2.5s infinite linear;
        }
        @keyframes scan {
            0% { top: 0%; }
            100% { top: 100%; }
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800">

    <div class="container mx-auto max-w-4xl p-4 md:p-8">
        
        <!-- Header -->
        <header class="text-center mb-8">
            <div class="flex items-center justify-center space-x-3">
                 <svg class="w-10 h-10 text-blue-500" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75m-3-7.036A11.959 11.959 0 013.598 6 11.99 11.99 0 003 9.749c0 5.592 3.824 10.29 9 11.623 5.176-1.332 9-6.03 9-11.622 0-1.31-.21-2.571-.598-3.751h-.152c-3.196 0-6.1-1.248-8.25-3.286zm0 13.036h.008v.008h-.008v-.008z" />
                </svg>
                <h1 class="text-3xl md:text-4xl font-bold text-gray-900">PharmaTrace</h1>
            </div>
            <p class="text-gray-600 mt-2">Verifying Drug Authenticity on the Blockchain</p>
        </header>

        <!-- Wallet Connection -->
        <div id="wallet-section" class="mb-6 p-4 bg-white rounded-lg shadow-md border border-gray-200 flex items-center justify-between flex-wrap">
            <div class="flex-grow mb-2 md:mb-0">
                <p id="connection-status" class="text-sm font-medium text-red-600">Status: Not Connected</p>
                <p id="wallet-address" class="text-xs text-gray-500 truncate">No wallet address</p>
            </div>
            <button id="connect-wallet-btn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">
                Connect Wallet
            </button>
        </div>

        <!-- Tabs -->
        <div class="mb-6 border-b border-gray-200">
            <nav class="flex space-x-4" aria-label="Tabs">
                <button onclick="changeTab('verify')" class="tab-button active py-3 px-4 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition" data-tab="verify">
                    Verify Drug
                </button>
                <button id="admin-tab-button" onclick="changeTab('admin')" class="tab-button hidden py-3 px-4 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition" data-tab="admin">
                    Admin Panel (Owner)
                </button>
                <button onclick="changeTab('register')" class="tab-button py-3 px-4 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition" data-tab="register">
                    Register Drug (Manufacturer)
                </button>
                <button onclick="changeTab('transfer')" class="tab-button py-3 px-4 text-sm font-medium text-center text-gray-500 border-b-2 border-transparent hover:text-gray-700 hover:border-gray-300 transition" data-tab="transfer">
                    Transfer Ownership
                </button>
            </nav>
        </div>

        <main>
            <!-- Verify Drug Tab -->
            <div id="verify-tab" class="space-y-6">
                <div class="p-6 bg-white rounded-lg shadow-md border border-gray-200">
                    <h2 class="text-xl font-semibold mb-4 text-gray-800">Verify Drug</h2>
                    <!-- Option 1: Scan QR Code -->
                    <div class="mb-4">
                        <p class="text-sm text-gray-600 mb-4">Scan the unique QR code on the drug packaging.</p>
                        <div id="scanner-ui" class="hidden space-y-4">
                            <div id="qr-reader-container" class="bg-gray-900">
                                <div id="qr-reader"></div>
                                <div class="scanner-line"></div>
                            </div>
                            <button id="stop-scan-btn" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Stop Scanning</button>
                        </div>
                        <button id="start-scan-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Start Camera Scan</button>
                    </div>

                    <!-- Divider -->
                    <div class="relative flex py-2 items-center">
                        <div class="flex-grow border-t border-gray-300"></div>
                        <span class="flex-shrink mx-4 text-gray-400 text-sm">OR</span>
                        <div class="flex-grow border-t border-gray-300"></div>
                    </div>

                    <!-- Option 2: Manual Entry -->
                    <form id="verify-by-id-form" class="space-y-4 mt-4">
                        <div>
                            <label for="verify-unique-id" class="block text-sm font-medium text-gray-700">Enter Unique ID Manually</label>
                            <input type="text" id="verify-unique-id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" placeholder="e.g., DRUG-XYZ-123" required>
                        </div>
                        <button type="submit" class="w-full bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Verify by ID</button>
                    </form>
                </div>
                <div id="verification-result" class="hidden p-6 bg-white rounded-lg shadow-md border border-gray-200"></div>
            </div>
            
             <!-- Admin Panel Tab -->
            <div id="admin-tab" class="hidden space-y-6">
                <form id="add-manufacturer-form" class="p-6 bg-white rounded-lg shadow-md border border-gray-200 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800">Add Manufacturer</h2>
                    <div>
                        <label for="add-manufacturer-address" class="block text-sm font-medium text-gray-700">New Manufacturer Address</label>
                        <input type="text" id="add-manufacturer-address" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Add Manufacturer</button>
                </form>
                 <form id="remove-manufacturer-form" class="p-6 bg-white rounded-lg shadow-md border border-gray-200 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800">Remove Manufacturer</h2>
                    <div>
                        <label for="remove-manufacturer-address" class="block text-sm font-medium text-gray-700">Manufacturer Address to Remove</label>
                        <input type="text" id="remove-manufacturer-address" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Remove Manufacturer</button>
                </form>
            </div>

            <!-- Register Drug Tab -->
            <div id="register-tab" class="hidden space-y-6">
                 <form id="register-form" class="p-6 bg-white rounded-lg shadow-md border border-gray-200 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800">Register New Drug Batch</h2>
                    <div>
                        <label for="drug-name" class="block text-sm font-medium text-gray-700">Drug Name</label>
                        <input type="text" id="drug-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                     <div>
                        <label for="batch-number" class="block text-sm font-medium text-gray-700">Batch Number</label>
                        <input type="text" id="batch-number" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                     <div>
                        <label for="unique-id" class="block text-sm font-medium text-gray-700">Unique ID (QR Code Data)</label>
                        <input type="text" id="unique-id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Register on Blockchain</button>
                </form>
                <div id="qr-code-result" class="hidden p-6 bg-white rounded-lg shadow-md border border-gray-200 text-center">
                    <h3 class="text-lg font-semibold mb-4 text-gray-800">Registration Successful!</h3>
                    <p class="text-sm text-gray-600 mb-4">Print or save this QR code and attach it to the drug packaging.</p>
                    <div id="qrcode-container" class="flex justify-center mb-4" data-id=""></div>
                    <button id="download-qr-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Download QR Code</button>
                </div>
            </div>

            <!-- Transfer Ownership Tab -->
            <div id="transfer-tab" class="hidden">
                <form id="transfer-form" class="p-6 bg-white rounded-lg shadow-md border border-gray-200 space-y-4">
                    <h2 class="text-xl font-semibold text-gray-800">Transfer Drug Ownership</h2>
                     <div>
                        <label for="transfer-unique-id" class="block text-sm font-medium text-gray-700">Unique ID (from Scanned QR)</label>
                        <input type="text" id="transfer-unique-id" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                     <div>
                        <label for="new-owner" class="block text-sm font-medium text-gray-700">New Owner's Wallet Address</label>
                        <input type="text" id="new-owner" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500" required>
                    </div>
                    <button type="submit" class="w-full bg-purple-500 hover:bg-purple-600 text-white font-bold py-2 px-4 rounded-lg transition duration-300">Initiate Transfer</button>
                </form>
            </div>
        </main>
        
        <!-- Status/Log Section -->
        <div id="status-log" class="mt-8 p-4 bg-gray-900 text-white rounded-lg shadow-md text-xs font-mono h-48 overflow-y-auto">
            <p>> PharmaTrace log initialized. Waiting for wallet connection...</p>
        </div>

    </div>

    <script>
        // --- Globals & DOM Elements ---
        const connectWalletBtn = document.getElementById('connect-wallet-btn');
        const connectionStatus = document.getElementById('connection-status');
        const walletAddressEl = document.getElementById('wallet-address');
        const statusLog = document.getElementById('status-log');
        
        const tabs = {
            verify: document.getElementById('verify-tab'),
            admin: document.getElementById('admin-tab'),
            register: document.getElementById('register-tab'),
            transfer: document.getElementById('transfer-tab'),
        };
        const tabButtons = document.querySelectorAll('.tab-button');
        const adminTabButton = document.getElementById('admin-tab-button');
        
        const startScanBtn = document.getElementById('start-scan-btn');
        const stopScanBtn = document.getElementById('stop-scan-btn');
        const scannerUi = document.getElementById('scanner-ui');
        const verificationResult = document.getElementById('verification-result');
        const verifyByIdForm = document.getElementById('verify-by-id-form'); // NEW

        const registerForm = document.getElementById('register-form');
        const transferForm = document.getElementById('transfer-form');
        const addManufacturerForm = document.getElementById('add-manufacturer-form');
        const removeManufacturerForm = document.getElementById('remove-manufacturer-form');
        
        const qrCodeResult = document.getElementById('qr-code-result');
        const qrcodeContainer = document.getElementById('qrcode-container');
        const downloadQrBtn = document.getElementById('download-qr-btn');

        let provider;
        let signer;
        let contract;
        let walletAddress;
        let html5QrCode;

        // --- IMPORTANT: DEPLOYMENT CONFIGURATION ---
        const contractAddress = "0x9EA41197ce69CA8533fC9cd282C5fa016e419416";
        const contractABI = [
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_account",
				"type": "address"
			}
		],
		"name": "addManufacturer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [],
		"stateMutability": "nonpayable",
		"type": "constructor"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "string",
				"name": "uniqueId",
				"type": "string"
			},
			{
				"indexed": false,
				"internalType": "string",
				"name": "drugName",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "manufacturer",
				"type": "address"
			}
		],
		"name": "DrugRegistered",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "string",
				"name": "uniqueId",
				"type": "string"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "from",
				"type": "address"
			},
			{
				"indexed": true,
				"internalType": "address",
				"name": "to",
				"type": "address"
			}
		],
		"name": "DrugTransferred",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "ManufacturerAdded",
		"type": "event"
	},
	{
		"anonymous": false,
		"inputs": [
			{
				"indexed": true,
				"internalType": "address",
				"name": "account",
				"type": "address"
			}
		],
		"name": "ManufacturerRemoved",
		"type": "event"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_uniqueId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_drugName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "_batchNumber",
				"type": "string"
			}
		],
		"name": "registerDrug",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "_account",
				"type": "address"
			}
		],
		"name": "removeManufacturer",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_uniqueId",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "_newOwner",
				"type": "address"
			}
		],
		"name": "transferDrug",
		"outputs": [],
		"stateMutability": "nonpayable",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			}
		],
		"name": "drugs",
		"outputs": [
			{
				"internalType": "string",
				"name": "uniqueId",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "drugName",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "batchNumber",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "manufacturer",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "currentOwner",
				"type": "address"
			},
			{
				"internalType": "bool",
				"name": "isRegistered",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_uniqueId",
				"type": "string"
			}
		],
		"name": "getDrugDetails",
		"outputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			},
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "_uniqueId",
				"type": "string"
			}
		],
		"name": "getTransferHistory",
		"outputs": [
			{
				"internalType": "address[]",
				"name": "",
				"type": "address[]"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"name": "isManufacturer",
		"outputs": [
			{
				"internalType": "bool",
				"name": "",
				"type": "bool"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [],
		"name": "owner",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	},
	{
		"inputs": [
			{
				"internalType": "string",
				"name": "",
				"type": "string"
			},
			{
				"internalType": "uint256",
				"name": "",
				"type": "uint256"
			}
		],
		"name": "transferHistory",
		"outputs": [
			{
				"internalType": "address",
				"name": "",
				"type": "address"
			}
		],
		"stateMutability": "view",
		"type": "function"
	}
];
        // --- END DEPLOYMENT CONFIGURATION ---


        // --- Logging Utility ---
        function log(message) {
            const now = new Date();
            const timestamp = now.toLocaleTimeString();
            statusLog.innerHTML += `<p>> [${timestamp}] ${message}</p>`;
            statusLog.scrollTop = statusLog.scrollHeight;
        }

        // --- Wallet & Blockchain Interaction ---
        async function connectWallet() {
            if (!contractAddress || contractAddress.startsWith('PASTE_')) {
                alert('Deployment Configuration Missing: Please update the contractAddress in the HTML file.');
                return;
            }
             if (!contractABI || contractABI.length === 0) {
                alert('Deployment Configuration Missing: Please update the contractABI in the HTML file.');
                return;
            }

            if (typeof window.ethereum === 'undefined') {
                log('MetaMask is not installed. Please install it to use this dApp.');
                alert('Please install MetaMask to use this dApp.');
                return;
            }

            try {
                log('Requesting wallet connection...');
                provider = new ethers.providers.Web3Provider(window.ethereum);
                await provider.send("eth_requestAccounts", []);
                signer = provider.getSigner();
                walletAddress = await signer.getAddress();
                
                contract = new ethers.Contract(contractAddress, contractABI, signer);
                
                log(`Wallet connected successfully.`);
                
                const ownerAddress = await contract.owner();
                updateWalletUI(true, ownerAddress);

            } catch (error) {
                log(`Error connecting wallet: ${error.message}`);
                console.error(error);
                updateWalletUI(false, null);
            }
        }
        
        function updateWalletUI(isConnected, ownerAddress) {
            if (isConnected) {
                connectionStatus.textContent = 'Status: Connected';
                connectionStatus.className = 'text-sm font-medium text-green-600';
                walletAddressEl.textContent = `Address: ${walletAddress}`;
                connectWalletBtn.textContent = 'Wallet Connected';
                connectWalletBtn.disabled = true;
                connectWalletBtn.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                connectWalletBtn.classList.add('bg-gray-400', 'cursor-not-allowed');

                if (walletAddress.toLowerCase() === ownerAddress.toLowerCase()) {
                    log('Owner wallet connected. Displaying Admin Panel.');
                    adminTabButton.classList.remove('hidden');
                }

            } else {
                connectionStatus.textContent = 'Status: Not Connected';
                connectionStatus.className = 'text-sm font-medium text-red-600';
                walletAddressEl.textContent = 'No wallet address';
                adminTabButton.classList.add('hidden'); // Hide on disconnect
            }
        }

        // --- UI & Tab Logic ---
        function changeTab(tabName) {
            Object.values(tabs).forEach(tab => tab.classList.add('hidden'));
            tabButtons.forEach(button => button.classList.remove('active'));

            tabs[tabName].classList.remove('hidden');
            document.querySelector(`.tab-button[data-tab="${tabName}"]`).classList.add('active');
            log(`Switched to '${tabName}' tab.`);
        }

        // --- QR Code Scanner Logic ---
        function onScanSuccess(decodedText, decodedResult) {
            log(`QR Code detected: ${decodedText}`);
            html5QrCode.stop().then(() => {
                scannerUi.classList.add('hidden');
                startScanBtn.classList.remove('hidden');
                fetchDrugHistory(decodedText);
            }).catch(err => console.error("Failed to stop QR scanner:", err));
        }

        function onScanFailure(error) { /* Do nothing to avoid log spam */ }

        function setupScanner() {
            html5QrCode = new Html5Qrcode("qr-reader");
            startScanBtn.addEventListener('click', () => {
                log('Starting camera for QR scan...');
                scannerUi.classList.remove('hidden');
                startScanBtn.classList.add('hidden');
                verificationResult.classList.add('hidden');
                
                const config = { fps: 10, qrbox: { width: 250, height: 250 } };
                html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess, onScanFailure)
                    .catch(err => log(`Error starting scanner: ${err}`));
            });
            
            stopScanBtn.addEventListener('click', () => {
                log('Stopping camera scan.');
                html5QrCode.stop().then(() => {
                     scannerUi.classList.add('hidden');
                     startScanBtn.classList.remove('hidden');
                }).catch(err => log(`Error stopping scanner: ${err}`));
            });
        }
        
        // --- Core dApp Logic ---
        async function fetchDrugHistory(uniqueId) {
            log(`Fetching history for drug ID: ${uniqueId}`);
            verificationResult.classList.remove('hidden');
            verificationResult.innerHTML = `<div class="flex items-center space-x-2"><div class="animate-spin rounded-full h-5 w-5 border-b-2 border-gray-900"></div><p>Fetching data from the blockchain...</p></div>`;

            try {
                const drugInfo = await contract.getDrugDetails(uniqueId);
                const history = await contract.getTransferHistory(uniqueId);
                const [id, name, batch, manufacturer, currentOwner] = drugInfo;
                
                if (!drugInfo.isRegistered) {
                    throw new Error("Drug with this ID is not registered.");
                }
                
                let historyHtml = history.map((addr, index) => {
                    const role = index === 0 ? 'Manufacturer' : `Owner #${index + 1}`;
                    const isCurrentOwner = addr.toLowerCase() === currentOwner.toLowerCase();
                    const badgeClass = isCurrentOwner ? 'bg-blue-100 text-blue-800' : 'bg-gray-100 text-gray-800';
                    const badgeText = isCurrentOwner ? 'Current Owner' : '';
                    
                    return `
                        <li class="flex items-center justify-between p-3 rounded-md transition hover:bg-gray-50">
                            <div class="flex items-center">
                                <span class="flex items-center justify-center h-8 w-8 rounded-full bg-gray-200 text-sm font-bold mr-3">${index + 1}</span>
                                <div>
                                    <p class="font-semibold text-gray-700">${role}</p>
                                    <p class="text-xs text-gray-500 font-mono">${addr}</p>
                                </div>
                            </div>
                            ${badgeText ? `<span class="text-xs font-semibold px-2 py-1 rounded-full ${badgeClass}">${badgeText}</span>` : ''}
                        </li>`;
                }).join('');

                verificationResult.innerHTML = `
                    <div class="flex items-center space-x-3 text-green-600 mb-4">
                         <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        <h3 class="text-2xl font-bold">Drug Verified</h3>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mb-6 bg-gray-50 p-4 rounded-lg">
                        <p><strong>Name:</strong> ${name}</p>
                        <p><strong>Batch:</strong> ${batch}</p>
                        <p class="md:col-span-2"><strong>Unique ID:</strong> ${id}</p>
                    </div>
                    <h4 class="font-semibold mb-3 text-lg">Chain of Custody:</h4>
                    <ul class="space-y-2">${historyHtml}</ul>
                `;
            } catch (error) {
                log(`Verification failed: ${error.message}`);
                verificationResult.innerHTML = `
                    <div class="flex items-center space-x-3 text-red-600">
                        <svg class="w-8 h-8" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126z" /></svg>
                        <h3 class="text-2xl font-bold">Verification Failed</h3>
                    </div>
                    <p class="mt-2 text-sm text-gray-600">This drug's unique ID was not found on the blockchain. It may be counterfeit or unregistered.</p>
                    <p class="mt-1 text-xs text-red-700 font-mono">Error: ${error.reason || error.message}</p>
                `;
            }
        }
        
        async function handleTransaction(form, transactionPromise, successMessage) {
            const button = form.querySelector('button[type="submit"]');
            const originalButtonText = button.textContent;
            button.disabled = true;
            button.textContent = 'Processing...';

            try {
                const tx = await transactionPromise;
                log('Transaction sent... waiting for confirmation...');
                await tx.wait();
                log(successMessage);
                alert(successMessage);
                form.reset();
            } catch (error) {
                const reason = error.reason || "An unknown error occurred.";
                log(`Transaction error: ${reason}`);
                alert(`Error: ${reason}`);
                console.error(error);
            } finally {
                button.disabled = false;
                button.textContent = originalButtonText;
            }
        }

        addManufacturerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const address = document.getElementById('add-manufacturer-address').value;
            await handleTransaction(e.target, contract.addManufacturer(address), `Successfully added manufacturer: ${address}`);
        });

        removeManufacturerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const address = document.getElementById('remove-manufacturer-address').value;
            await handleTransaction(e.target, contract.removeManufacturer(address), `Successfully removed manufacturer: ${address}`);
        });

        registerForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const drugName = document.getElementById('drug-name').value;
            const batchNumber = document.getElementById('batch-number').value;
            const uniqueId = document.getElementById('unique-id').value;

            qrCodeResult.classList.add('hidden'); 

            const button = e.target.querySelector('button[type="submit"]');
            const originalButtonText = button.textContent;
            button.disabled = true;
            button.textContent = 'Processing...';

            try {
                const tx = await contract.registerDrug(uniqueId, drugName, batchNumber);
                log('Transaction sent... waiting for confirmation...');
                await tx.wait();
                const successMessage = `Successfully registered drug: ${drugName}`;
                log(successMessage);
                alert(successMessage);

                qrcodeContainer.innerHTML = '';
                qrcodeContainer.dataset.id = uniqueId;
                QRCode.toCanvas(document.createElement('canvas'), uniqueId, { width: 220, margin: 1 }, function (error, canvas) {
                    if (error) throw error;
                    qrcodeContainer.appendChild(canvas);
                    qrCodeResult.classList.remove('hidden');
                    log(`Generated QR code for ID: ${uniqueId}`);
                });
                
                e.target.reset();
            } catch (error) {
                const reason = error.reason || "An unknown error occurred.";
                log(`Transaction error: ${reason}`);
                alert(`Error: ${reason}`);
                console.error(error);
            } finally {
                button.disabled = false;
                button.textContent = originalButtonText;
            }
        });

        transferForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const uniqueId = document.getElementById('transfer-unique-id').value;
            const newOwner = document.getElementById('new-owner').value;
            await handleTransaction(e.target, contract.transferDrug(uniqueId, newOwner), `Successfully transferred drug ${uniqueId}`);
        });
        
        downloadQrBtn.addEventListener('click', () => {
            const canvas = qrcodeContainer.querySelector('canvas');
            const uniqueId = qrcodeContainer.dataset.id;
            if (canvas && uniqueId) {
                const dataUrl = canvas.toDataURL('image/png');
                const link = document.createElement('a');
                link.download = `PharmaTrace-QR-${uniqueId}.png`;
                link.href = dataUrl;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                log(`Downloading QR code for ID: ${uniqueId}`);
            } else {
                log('Error: Could not find QR code or ID to download.');
                alert('Could not find QR code to download.');
            }
        });
        
        // NEW: Event listener for manual ID verification
        verifyByIdForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const uniqueIdInput = document.getElementById('verify-unique-id');
            const uniqueId = uniqueIdInput.value.trim();
            if (uniqueId) {
                log(`Manually verifying ID: ${uniqueId}`);
                verificationResult.classList.add('hidden'); // Hide previous results
                fetchDrugHistory(uniqueId);
            } else {
                alert('Please enter a Unique ID to verify.');
            }
        });

        // --- Initialization ---
        window.addEventListener('load', () => {
            log('PharmaTrace dApp loaded.');
            connectWalletBtn.addEventListener('click', connectWallet);
            setupScanner();
        });
    </script>
</body>
</html>

